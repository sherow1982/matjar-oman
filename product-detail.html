<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>تفاصيل المنتج - متجر عمان</title>
    <meta name="description" content="صفحة تفاصيل المنتج في متجر عمان. شراء منتجات عالية الجودة بأسعار تنافسية من سلطنة عمان.">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; background: #f9f9f9; color: #333; }
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header, footer { text-align: center; background-color: #fff; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header nav a, footer nav a { margin: 0 15px; color: #007bff; font-weight: bold; text-decoration: none; }
        .brand { font-size: 1.8rem; font-weight: bold; color: #333; text-decoration: none; display: block; margin-bottom: 10px; }
        footer { margin-top: 40px; padding-bottom: 20px;}
        img { max-width: 100%; border-radius: 10px; margin-bottom: 20px; }
        h1 { text-align: center; font-size: 2.5rem; }
        .price { text-align: center; font-size: 2rem; font-weight: bold; color: #28a745; }
        .old-price { text-decoration: line-through; color: #999; font-size: 1.2rem; }
        .description { white-space: pre-wrap; margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px; }
        .btn { display: block; background-color: #007bff; color: white; padding: 12px 30px; text-align: center; border-radius: 50px; font-weight: bold; text-decoration: none; margin: 20px auto; }
        .reviews-section { text-align: right; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 15px; }
        .review-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .review-stars { color: gold; font-size: 18px; }
        .review-author { font-weight: bold; }
        /* === كود خاص بأدوات الإدارة - مخفي للزبائن === */
        #admin-tools { background-color: #fff8e1; border: 2px dashed #ffc107; padding: 15px; margin-top: 30px; text-align: center; }
        #admin-tools h3 { margin-top: 0; }
        #admin-tools button { background-color: #c82333; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        #rss-output { width: 100%; height: 200px; margin-top: 10px; direction: ltr; text-align: left; }
    </style>
    
    <!-- === الخطوة 1: إضافة حاوية فارغة للبيانات المنظمة === -->
    <script id="json-ld-container" type="application/ld+json"></script>
    
</head>
<body>
    <header>
        <a href="index.html" target="_blank" class="brand">متجر عمان</a>
        <nav>
            <a href="blog.html" target="_blank">المدونة</a>
            <a href="who-we.html" target="_blank">من نحن</a>
            <a href="contact-us.html" target="_blank">تواصل معنا</a>
            <a href="shipping.html" target="_blank">الشحن</a>
        </nav>
    </header>
    <main class="container">
        <div id="product-detail">جارٍ تحميل بيانات المنتج...</div>
        <a href="index.html" target="_blank" style="display:block; text-align:center; margin-top:20px; font-weight:700; color:#007bff;">العودة للمنتجات</a>
        
        <!-- === الخطوة 2: إضافة قسم أدوات الإدارة لتوليد ملف الخلاصة === -->
        <div id="admin-tools" style="display:none;">
            <h3>أدوات خاصة بالمدير</h3>
            <p>هذا القسم يظهر لك فقط. استخدمه لتوليد ملف الخلاصة (RSS Feed).</p>
            <button onclick="generateRssFeed()">توليد ملف الخلاصة (RSS)</button>
            <textarea id="rss-output" readonly placeholder="سيظهر كود ملف الخلاصة هنا..."></textarea>
        </div>
        
    </main>
    <footer>
        <nav>
            <a href="terms-and-conditions.html" target="_blank">الشروط والأحكام</a>
            <a href="privacy-policy-page.html" target="_blank">سياسة الخصوصية</a>
            <a href="refund-policy.html" target="_blank">سياسة الاسترجاع</a>
        </nav>
        <p>© 2025 متجر عمان - جميع الحقوق محفوظة</p>
    </footer>

    <script>
        const productsUrl = 'https://raw.githubusercontent.com/sherow1982/matjar-oman/main/products.json';

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const productName = params.get('name');
            
            // إظهار أدوات الإدارة إذا كان الرابط يحتوي على كلمة "admin"
            if (params.has('admin')) {
                document.getElementById('admin-tools').style.display = 'block';
            }

            if (!productName) {
                document.getElementById('product-detail').textContent = 'لم يتم تحديد المنتج.';
                return;
            }

            fetch(productsUrl)
                .then(res => res.json())
                .then(products => {
                    const product = products.find(p => p.العنوان === productName);
                    if (!product) {
                        document.getElementById('product-detail').textContent = 'المنتج غير موجود.';
                        return;
                    }
                    document.title = `${product.العنوان} | متجر عمان`;
                    document.querySelector('meta[name="description"]').setAttribute("content", `اشترِ ${product.العنوان} بأفضل سعر في عمان. ${product.الوصف.substring(0, 150)}...`);
                    
                    // === الخطوة 3: توليد البيانات المنظمة للمنتج الحالي ===
                    generateStructuredData(product);
                    
                    displayProductDetails(product);
                });
        });

        function generateStructuredData(product) {
            const productUrl = window.location.href; // الرابط الكامل للصفحة الحالية
            const structuredData = {
                "@context": "https://schema.org/",
                "@type": "Product",
                "name": product.العنوان,
                "image": [ product['رابط الصورة'] ],
                "description": product.الوصف,
                "brand": { "@type": "Brand", "name": "متجر عمان" },
                "offers": {
                    "@type": "Offer",
                    "url": productUrl,
                    "priceCurrency": "OMR",
                    "price": product['ﺎﻠﺴﻋﺭ ﺎﻠﻤﺨﻔَّﺿ'].replace(/[^0-9.]/g, ''), // استخلاص الرقم فقط
                    "availability": "https://schema.org/InStock",
                    "itemCondition": "https://schema.org/NewCondition"
                }
            };
            document.getElementById('json-ld-container').textContent = JSON.stringify(structuredData);
        }
        
        // === الخطوة 4: دالة جديدة لتوليد ملف الخلاصة (RSS) ===
        function generateRssFeed() {
            fetch(productsUrl)
                .then(res => res.json())
                .then(products => {
                    let rssItems = '';
                    products.forEach(product => {
                        // بناء رابط صحيح لكل منتج
                        const productPageUrl = `https://sherow1982.github.io/matjar-oman/product-detail.html?name=${encodeURIComponent(product.العنوان)}`;
                        
                        rssItems += `
    <item>
      <title>${product.العنوان}</title>
      <link>${productPageUrl}</link>
      <description><![CDATA[${product.الوصف}]]></description>
      <guid isPermaLink="true">${productPageUrl}</guid>
      <pubDate>${new Date().toUTCString()}</pubDate>
    </item>`;
                    });

                    const rssFeed = `<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
  <title>متجر عمان</title>
  <link>https://sherow1982.github.io/matjar-oman/</link>
  <description>أحدث المنتجات في متجر عمان</description>
  <atom:link href="https://sherow1982.github.io/matjar-oman/feed.xml" rel="self" type="application/rss+xml" />${rssItems}
</channel>
</rss>`;
                    
                    const outputArea = document.getElementById('rss-output');
                    outputArea.value = rssFeed;
                    // تحديد النص بالكامل لتسهيل النسخ
                    outputArea.select();
                    alert('تم توليد ملف الخلاصة بنجاح! قم بنسخ المحتوى الآن.');
                });
        }
        
        // باقي الدوال تبقى كما هي بدون تغيير
        function displayProductDetails(product) {
            const container = document.getElementById('product-detail');
            container.innerHTML = `
                <h1>${product.العنوان}</h1>
                <img loading="lazy" src="${product['رابط الصورة']}" alt="صورة ${product.العنوان} في عمان">
                <p class="price">${product['ﺎﻠﺴﻋﺭ ﺎﻠﻤﺨﻔَّﺿ']} <span class="old-price">${product['ﺎﻠﺴﻋﺭ'] || ''}</span></p>
                <a href="${product.الرابط}" class="btn" target="_blank">اشتريه الآن من المتجر الأصلي</a>
                <div class="description"><h2>وصف المنتج</h2><p>${product.الوصف.replace(/\n/g, '<br>')}</p></div>
                <div class="reviews-section">
                    <h3>تقييمات المشترين</h3>
                    ${generateDynamicReviews()}
                </div>
            `;
        }

        function generateDynamicReviews() {
            const MALE_NAMES = ["سالم", "علي", "خالد", "ناصر", "سعود"];
            const FEMALE_NAMES = ["فاطمة", "مريم", "شيخة", "نورة", "عائشة"];
            const REVIEW_TEXTS = [
                "منتج فنان صراحة، ويستاهل كل ريال. ما ندمت إني خذيته.",
                "ما شاء الله على الجودة! وصلني بسرعة والتغليف كان ممتاز.",
                "حبيته واجد، عملي ومفيد فالبيت. كل حد يسألني عنه.",
                "لا تترددوا، منتج بطل ويستاهل التجربة. أنصحكم فيه وبقوة.",
                "والله منتج أصلي وحل لي مشكلة كبيرة. شكرًا لكم."
            ];
            let reviewsHtml = '';
            const allNames = [...MALE_NAMES, ...FEMALE_NAMES];
            const usedNames = new Set();
            const usedTexts = new Set();

            for (let i = 0; i < 5; i++) {
                let name, text;
                do { name = allNames[Math.floor(Math.random() * allNames.length)]; } while (usedNames.has(name));
                do { text = REVIEW_TEXTS[Math.floor(Math.random() * REVIEW_TEXTS.length)]; } while (usedTexts.has(text));
                
                usedNames.add(name);
                usedTexts.add(text);
                const rating = Math.floor(Math.random() * 2) + 4;
                const stars = '&#9733;'.repeat(rating) + '&#9734;'.repeat(5 - rating);

                reviewsHtml += `
                    <div class="review-item">
                        <div class="review-stars">${stars}</div>
                        <p class="review-author"><strong>${name} من مسقط</strong></p>
                        <p>${text}</p>
                    </div>
                `;
            }
            return reviewsHtml;
        }
    </script>
</body>
</html>
